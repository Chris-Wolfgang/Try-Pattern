# Sequential PR validation workflow with coverage gating
# Stage 1: Linux tests with 90% coverage requirement
# Stage 2: Windows and macOS tests (only if Linux passes)
# Stage 3: . NET Framework 4.x tests on Windows (only if Stage 2 passes)

name: PR Checks v2 (Gated)

permissions:
  contents: read
  
on:
  pull_request: 
    branches: 
      - main
      - develop
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '. github/workflows/**'

jobs:
  # ============================================================================
  # STAGE 1: Linux - . NET Core/5+ Tests with Coverage Gate
  # ============================================================================
  test-linux-core:
    name: "Stage 1: Linux Tests (.NET 8-9) + Coverage Gate"
    runs-on: ubuntu-latest
    if: github.repository != 'Chris-Wolfgang/repo-template'
    env:
      MSBUILDSKIPPROJFILTERS: '**/*DotNet4*. csproj;**/*DotNet4*.vbproj;**/*DotNet4*.fsproj'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # No longer needed - not testing .NET Core 3.1
      # - name: Install OpenSSL 1.1 for .NET Core 3.1
      #   run: |
      #     wget http://archive.ubuntu.com/ubuntu/pool/main/o/openssl/libssl1.1_1.1.1f-1ubuntu2_amd64.deb
      #     sudo dpkg -i libssl1.1_1.1.1f-1ubuntu2_amd64.deb

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            9.0.x

      - name: Restore dependencies (exclude .NET Framework)
        run: |
          echo "Restoring .NET 8-9 projects only (excluding .NET Framework)..."
          # Use MSBuild property to filter target frameworks
          dotnet restore /p:TargetFrameworks=\"net8.0\;net9.0\"

      - name: Build solution (exclude .NET Framework)
        run: |
          echo "Building .NET 8-9 projects only (excluding .NET Framework)..."
          # Build only .NET 8 and 9 framework targets
          dotnet build --no-restore --configuration Release \
            /p:TargetFrameworks=\"net8.0\;net9.0\"

      - name: Run tests with coverage (.NET 8.0-9.0)
        run: |
          # Test each framework individually to ensure all are tested
          frameworks=(net8.0 net9.0)
          
          for fw in "${frameworks[@]}"; do
            echo "=========================================="
            echo "Testing framework: $fw"
            echo "=========================================="
            
            dotnet test tests/TryPattern.Tests/TryPattern.Tests.csproj \
              --no-build \
              --configuration Release \
              --framework "$fw" \
              --collect:"XPlat Code Coverage" \
              --results-directory "./TestResults" \
              --logger "console;verbosity=minimal" || exit 1
          done

      - name: Install ReportGenerator
        run: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: Generate coverage report
        run: |
          reportgenerator \
            -reports:"TestResults/**/coverage.cobertura.xml" \
            -targetdir:"CoverageReport" \
            -reporttypes:"Html;TextSummary;MarkdownSummaryGithub;CsvSummary"

      - name:  Enforce 90% coverage threshold
        run: |
          if [ !  -f CoverageReport/Summary.txt ]; then
            echo "‚ùå Coverage report not generated!"
            exit 1
          fi

          echo "Coverage Summary:"
          cat CoverageReport/Summary.txt
          echo ""
          
          failed_projects=""
          threshold=90
          
          while read -r line; do
            # Match lines with module names and percentages
            if echo "$line" | grep -qE '^[^ ].*[0-9]+%$' && !  echo "$line" | grep -q '^Summary'; then
              module=$(echo "$line" | awk '{print $1}')
              percent=$(echo "$line" | awk '{print $NF}' | tr -d '%')
              
              echo "Checking module: '$module' - Coverage: ${percent}%"
              
              if [ "$percent" -lt "$threshold" ]; then
                echo "  ‚ùå FAIL: Below ${threshold}% threshold"
                failed_projects="$failed_projects $module (${percent}%)"
              else
                echo "  ‚úÖ PASS:  Meets ${threshold}% threshold"
              fi
            fi
          done < CoverageReport/Summary. txt

          if [ -n "$failed_projects" ]; then
            echo ""
            echo "=========================================="
            echo "‚ùå COVERAGE GATE FAILED"
            echo "=========================================="
            echo "Projects below ${threshold}% coverage: $failed_projects"
            echo ""
            echo "Stage 1 failed.  Windows, macOS, and .NET Framework tests will NOT run."
            exit 1
          else
            echo ""
            echo "=========================================="
            echo "‚úÖ COVERAGE GATE PASSED"
            echo "=========================================="
            echo "All projects meet ${threshold}% coverage threshold."
            echo "Proceeding to Stage 2 (Windows and macOS tests)."
          fi

      - name: Upload Linux coverage results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name:  coverage-linux
          path: |
            TestResults/
            CoverageReport/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            src/**/bin/Release
            tests/**/bin/Release

  # ============================================================================
  # STAGE 2: Windows & macOS - .NET Core/5+ Tests (Gated by Stage 1)
  # ============================================================================
  test-windows-core:
    name: "Stage 2a: Windows Tests (.NET 8-9)"
    runs-on: windows-latest
    needs: test-linux-core
    if: github.repository != 'Chris-Wolfgang/repo-template'
    
    steps:
      - name:  Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            9.0.x

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --no-restore --configuration Release

      - name: Run tests (.NET 8-9)
        shell: pwsh
        run: |
          $frameworks = @('net8.0', 'net9.0')
          
          foreach ($fw in $frameworks) {
            Write-Host "==========================================" -ForegroundColor Cyan
            Write-Host "Testing framework: $fw" -ForegroundColor Cyan
            Write-Host "==========================================" -ForegroundColor Cyan
            
            dotnet test tests/TryPattern.Tests/TryPattern.Tests.csproj `
              --no-build `
              --configuration Release `
              --framework $fw `
              --logger "console;verbosity=normal"
            
            if ($LASTEXITCODE -ne 0) {
              Write-Error "Tests failed for $fw"
              exit 1
            }
          }

  test-macos-core: 
    name: "Stage 2b: macOS Tests (.NET 8-9)"
    runs-on: macos-latest
    needs: test-linux-core
    if: github.repository != 'Chris-Wolfgang/repo-template'
    env:
      MSBUILDSKIPPROJFILTERS: '**/*DotNet4*.csproj;**/*DotNet4*.vbproj;**/*DotNet4*. fsproj'
    
    steps:
      - name:  Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            9.0.x

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --no-restore --configuration Release

      - name: Run tests (.NET 8-9 only - ARM64 compatible)
        run: |
          frameworks=(net8.0 net9.0)
          
          for fw in "${frameworks[@]}"; do
            echo "=========================================="
            echo "Testing framework: $fw"
            echo "=========================================="
            
            dotnet test tests/TryPattern.Tests/TryPattern.Tests.csproj \
              --no-build \
              --configuration Release \
              --framework "$fw" \
              --logger "console;verbosity=normal" || exit 1
          done

      - name: Display macOS architecture info
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "‚ÑπÔ∏è  macOS Testing Notes"
          echo "=========================================="
          echo "Architecture: $(uname -m)"
          echo ""
          echo "Tested frameworks (ARM64 compatible):"
          echo "  - .NET 8.0 ‚úÖ"
          echo "  - .NET 9.0 ‚úÖ"
          echo ""
          echo ".NET 8 and 9 are tested on all platforms"

  # ============================================================================
  # STAGE 3: Windows - .NET Framework 4.x Tests (Gated by Stage 2)
  # ============================================================================
  test-windows-framework: 
    name: "Stage 3: Windows . NET Framework Tests (4.6.2-4.8.1)"
    runs-on: windows-latest
    needs: [test-windows-core, test-macos-core]
    if: github.repository != 'Chris-Wolfgang/repo-template'
    
    steps: 
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup . NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --no-restore --configuration Release

      - name:  Run . NET Framework tests (4.6.2 - 4.8.1)
        shell: pwsh
        run: |
          $frameworks = @('net462', 'net472', 'net48', 'net481')
          
          foreach ($fw in $frameworks) {
            Write-Host "==========================================" -ForegroundColor Cyan
            Write-Host "Testing framework: $fw" -ForegroundColor Cyan
            Write-Host "==========================================" -ForegroundColor Cyan
            
            dotnet test tests/TryPattern.Tests/TryPattern.Tests.csproj `
              --no-build `
              --configuration Release `
              --framework $fw `
              --logger "console;verbosity=normal"
            
            if ($LASTEXITCODE -ne 0) {
              Write-Error "Tests failed for $fw"
              exit 1
            }
          }
          
          Write-Host ""
          Write-Host "==========================================" -ForegroundColor Green
          Write-Host "‚úÖ ALL STAGES PASSED" -ForegroundColor Green
          Write-Host "==========================================" -ForegroundColor Green
          Write-Host "Stage 1:  Linux tests + 90% coverage ‚úÖ" -ForegroundColor Green
          Write-Host "Stage 2: Windows & macOS tests ‚úÖ" -ForegroundColor Green
          Write-Host "Stage 3: .NET Framework 4.x tests ‚úÖ" -ForegroundColor Green
          Write-Host ""
          Write-Host "PR is ready to merge!  üéâ" -ForegroundColor Green

  # ============================================================================
  # Security Scan (Runs in parallel with tests)
  # ============================================================================
  security-scan:
    name: "Security Scan (DevSkim)"
    runs-on: ubuntu-latest
    if: github.repository != 'Chris-Wolfgang/repo-template'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install DevSkim CLI
        run: dotnet tool install --global Microsoft.CST.DevSkim. CLI

      - name: Run DevSkim security scan
        continue-on-error: true
        run: |
          devskim analyze \
            --source-code .  \
            --file-format text \
            --output-file devskim-results.txt \
            -E \
            --ignore-rule-ids DS176209 \
            --ignore-globs "**/api/**,**/CoverageReport/**,**/TestResults/**"

      - name: Display security scan results
        if: always()
        run: |
          if [ -f devskim-results.txt ]; then
            echo "=========================================="
            echo "DevSkim Security Scan Results"
            echo "=========================================="
            cat devskim-results.txt
            echo ""
            
            if grep -qi "error\|critical\|high" devskim-results.txt; then
              echo "‚ö†Ô∏è Security issues detected - review required"
            else
              echo "‚úÖ No critical security issues found"
            fi
          else
            echo "‚úÖ No security issues found"
          fi

      - name: Upload security scan results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: devskim-results
          path: devskim-results.txt
          if-no-files-found: warn